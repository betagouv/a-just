FROM node:22 AS builder
WORKDIR /home/api
# Install dependencies first to leverage Docker layer caching
COPY ./api/package*.json /home/api/
RUN if [ -f package-lock.json ]; then npm ci --include=dev; else npm install --include=dev; fi
# Copy source and build
COPY ./api /home/api
RUN npm run build

FROM node:22 AS runtime
WORKDIR /home/api
ENV NODE_ENV=production
# Copy built app and dependencies
COPY --from=builder /home/api/dist /home/api/dist
COPY --from=builder /home/api/node_modules /home/api/node_modules
COPY ./api/package*.json /home/api/
# Start fast: no install/build at runtime
CMD echo "NODE_ENV = $NODE_ENV"; npm run start:production;
