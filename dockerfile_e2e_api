FROM node:22 AS builder
ARG SKIP_FRONT_ADMIN=0
WORKDIR /home/api
# Install dependencies first to leverage Docker layer caching
COPY ./api/package*.json /home/api/
RUN if [ -f package-lock.json ]; then npm ci --include=dev; else npm install --include=dev; fi
# Copy source and build
COPY ./api /home/api
RUN npm run build

# Build front (Angular) and front-admin, and place their outputs where the API expects them at runtime
WORKDIR /home/front
# Build-time env for Angular front
ARG NG_APP_SERVER_URL
ARG NG_APP_NODE_ENV=test
ARG NG_APP_VERSION=local
ARG NG_APP_MATOMO
ARG NG_APP_MATOMO_TM
ARG NG_APP_SENTRY_DSN
ARG NG_APP_SENTRY_TRACES_SAMPLE_RATE=0

# Expose them to the build steps (used by @ngx-env/builder)
ENV NG_APP_SERVER_URL=${NG_APP_SERVER_URL}
ENV NG_APP_NODE_ENV=${NG_APP_NODE_ENV}
ENV NG_APP_VERSION=${NG_APP_VERSION}
ENV NG_APP_MATOMO=${NG_APP_MATOMO}
ENV NG_APP_MATOMO_TM=${NG_APP_MATOMO_TM}
ENV NG_APP_SENTRY_DSN=${NG_APP_SENTRY_DSN}
ENV NG_APP_SENTRY_TRACES_SAMPLE_RATE=${NG_APP_SENTRY_TRACES_SAMPLE_RATE}
# Ensure Angular uses the test configuration (base href '/')
ENV NODE_ENV=${NG_APP_NODE_ENV}
COPY ./front/package*.json /home/front/
RUN if [ -f package-lock.json ]; then npm ci --include=dev; else npm install --include=dev; fi
# Ensure esbuild native binary matches the library version inside this image
RUN npm rebuild esbuild || true
COPY ./front /home/front
RUN npm run build

WORKDIR /home/front-admin
ENV NODE_ENV=${NG_APP_NODE_ENV}
COPY ./front-admin/package*.json /home/front-admin/
RUN if [ -f package-lock.json ]; then npm ci --include=dev; else npm install --include=dev; fi
# Ensure esbuild native binary matches the library version inside this image
RUN npm rebuild esbuild || true
COPY ./front-admin /home/front-admin
RUN if [ "$SKIP_FRONT_ADMIN" = "1" ]; then echo "[e2e] Skipping front-admin build (SKIP_FRONT_ADMIN=1)"; else npm run build; fi

# Move built front apps into API dist paths expected by CSP/index serving
WORKDIR /home
RUN mkdir -p /home/api/dist/front /home/api/dist/front-admin && \
    if [ -d /home/front/dist/browser ]; then cp -r /home/front/dist/browser/* /home/api/dist/front/; fi && \
    if [ -d /home/front-admin/dist/browser ]; then cp -r /home/front-admin/dist/browser/* /home/api/dist/front-admin/; fi

FROM node:22 AS runtime
WORKDIR /home/api
ENV NODE_ENV=production
# Copy built app and dependencies
COPY --from=builder /home/api/dist /home/api/dist
COPY --from=builder /home/api/node_modules /home/api/node_modules
COPY ./api/package*.json /home/api/
# Start fast: no install/build at runtime
CMD echo "NODE_ENV = $NODE_ENV"; npm run start:production;

