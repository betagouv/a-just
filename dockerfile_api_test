FROM node:22
# Force rebuild: 2024-09-26-14:23

COPY ./api /home/api
WORKDIR /home/api

#RUN apt-get -y install iptables cron
RUN mkdir -p test/reports coverage src/front && \
    echo '<!DOCTYPE html><html><head></head><body></body></html>' > src/front/index.html

CMD echo "NODE_ENV = $NODE_ENV"; \
    npm ci && \
    echo "=== Package verification ==="; \
    echo "Mocha version:" && npx mocha --version || true; \
    node -e "try{console.log('mochawesome version:', require('mochawesome/package.json').version)}catch(e){console.log('mochawesome not found')};" && \
    node -e "try{console.log('mocha-multi-reporters version:', require('mocha-multi-reporters/package.json').version)}catch(e){console.log('mocha-multi-reporters not found')};" && \
    echo "=== Building ==="; \
    npm run build:test && \
    echo "=== Running tests with mochawesome reporter ==="; \
    npm test || echo "Test failed with exit code: $?"; \
    echo "=== Post-test verification ==="; \
    echo "Contents of test/reports inside container:" && ls -la test/reports || true; \
    echo "Contents of mochawesome-report (default) inside container:" && ls -la mochawesome-report 2>/dev/null || echo "No default mochawesome-report folder"; \
    echo "Contents of coverage inside container:" && ls -la coverage || true; \
    echo "Looking for any mochawesome files:" && find . -name "mochawesome*" -type f 2>/dev/null | head -20 || echo "No mochawesome files found";
# Utile pour debugguer et rentrer dans le conteneur si celui-ci n'est plus OK
#sleep infinity;
