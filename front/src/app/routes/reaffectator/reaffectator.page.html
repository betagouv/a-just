<aj-wrapper #wrapper title="Simulation d’affectations" [actionTemplate]="actions"
  class="dark-screen content-margin-null header-border-none">
  <div class="container" [ngClass]="{print: duringPrint}">
    <div class="title">
      <aj-date-select title="A la date d'" class="dark-mode" [value]="dateSelected"
        (valueChange)="onDateChanged($event)">
      </aj-date-select>
      <aj-select title="Filtrer par catégorie" class="dark-mode category-select"
        [value]="reaffectatorService.selectedCategoriesId" [multiple]="false" [datas]="formFilterSelect"
        (valueChange)="onSelectedCategoriesIdChanged($event)">
      </aj-select>
      <aj-select title="Filtrer par fonction" class="dark-mode" [value]="reaffectatorService.selectedFonctionsIds"
        [datas]="formFilterFonctionsSelect" (valueChange)="onSelectedFonctionsIdsChanged($event)">
      </aj-select>
      <aj-select title="Filtrer par contentieux" class="dark-mode" [value]="reaffectatorService.selectedReferentielIds"
        [datas]="formReferentiel" (valueChange)="onSelectedReferentielIdsChanged($event)">
      </aj-select>
      <div class="flex-1"></div>
      <aj-input-button class="dark-mode" title="Rechercher un collaborateur" placeholder="Indiquer le nom"
        [ngModel]="searchValue" (valueChange)="searchValue = $event; onSearchBy()" (search)="onSearchBy()"
        ngDefaultControl icon="">
      </aj-input-button>
      <div class="search-next" *ngIf="valuesFinded !== null">
        <mat-icon matSuffix (click)="onFindNext(-1)" class="cursor-pointer">expand_less
        </mat-icon>
        <mat-icon matSuffix *ngIf="valuesFinded !== null" (click)="onFindNext()" class="cursor-pointer">
          expand_more
        </mat-icon>
      </div>
    </div>

    <div class="indicators">
      <div class="profil">
        <div class="label-container">
          <i *ngIf="!showIndicatorPanel" class="ri-eye-line" (click)="showIndicatorPanel = true"></i>
          <i *ngIf="showIndicatorPanel" class="ri-eye-off-line" (click)="showIndicatorPanel = false"></i>
          <p>Compteurs</p>
        </div>
        <ng-template [ngIf]="showIndicatorPanel">
          <div class="contentieux-label">
            <div class="text">
              <div class="taux-row">
                <p>Taux de couverture :</p>
              </div>
              <div class="dtes-row">
                <p>DTES (en mois) :</p>
              </div>
              <div class="etp-target-row">
                <p>ETPT cibles :</p>
              </div>
              <div class="total-etp-row">
                <p>ETPT ventilés :</p>
              </div>
            </div>
          </div>
        </ng-template>
      </div>
      <ng-template [ngIf]="showIndicatorPanel">
        <div class="activities">
          <div class="sub-item" *ngFor="let ref of referentiel; let index = index">
            <div class="taux-row">
              <div class="taux">
                <aj-speedometer class="with-auto small-text" [classDarkMode]="true" [percent]="ref.coverage">
                </aj-speedometer>
              </div>
            </div>
            <div class="dtes-row">
              <div class="dtes">
                <p>{{ref.dtes | number:".2-2"}}</p>
              </div>
            </div>
            <div class="etp-target-row">
              <input [(ngModel)]="firstETPTargetValue[index]" placeholder="-" />
            </div>
            <div class="total-etp-row">
              <p>{{ref.realEtp | number:".2-2"}}</p>
            </div>
          </div>
        </div>
      </ng-template>
      <div class="actions"></div>
    </div>

    <div class="content-list" id="container-list">
      <ng-template ngFor let-list let-i="index" [ngForOf]="listFormated" [ngForTrackBy]="trackById">
        <div class="header-list">
          <div class="profil">
            <div class="label-container">
              <div class="check-item" [ngClass]="{selected: list.personSelected.length === list.hrFiltered.length}"
                (click)="toogleCheckAllPerson(i)">{{ list.personSelected.length ? list.personSelected.length : '' }}
              </div>
              <p class="label">{{ list.personSelected.length > 1 ? 'sélections' : 'sélection' }}</p>
              <p class="btn" (click)="onInitList(list)">
                Réinitialiser
              </p>
            </div>
            <div class="contentieux-label">
              <div class="label">
                <p>Contentieux :</p>
              </div>
              <div class="etp">
                <p>ETPT simulés :</p>
              </div>
              <div class="filter">
                <p class="etp-header">Trier par :</p>
              </div>
            </div>
          </div>
          <div class="activities">
            <div class="sub-item" *ngFor="let ref of list.referentiel; let index = index"
              [class.selected]="filterSelected && filterSelected.id === ref.id" (click)="onFilterBy(ref)">
              <div class="label">
                <p>{{ referentielMappingName(ref.label) }}</p>
              </div>
              <div class="etp">
                <p>{{ ref.totalAffected | number:'0.2-2' }}</p>
              </div>
              <div class="filter">
                <i class="ri-sort-desc"></i>
              </div>
            </div>
          </div>
          <div class="actions"></div>
        </div>

        <div class="sub-content-list">
          <div class="item-list" *ngFor="let hr of list.hrFiltered; trackBy: trackById; let index = index"
            [style.opacity]="hr.opacity" [id]="'human-'+hr.id">
            <div class="profil item">
              <div class="text">
                <div class="name">
                  <div class="check-item" [ngClass]="{selected: list.personSelected.indexOf(hr.id) !== -1}"
                    (click)="toogleCheckPerson(i, hr)"></div>
                  <p>{{ hr.firstName}} {{ hr.lastName}}</p>
                  <div *ngIf="hr.comment" class="tooltip">
                    <mat-icon>message</mat-icon>
                    <span class="tooltiptext">{{ hr.comment }}</span>
                  </div>
                </div>
                <div class="tags">
                  <p *ngIf="hr.fonction && hr.fonction.code" class="function">
                    {{ hr.fonction && hr.fonction.code}}
                  </p>
                  <p class="etp">{{ hr.etpLabel }}</p>
                  <p class="unavailable" *ngIf="hr.hasIndisponibility">
                    <mat-icon>error</mat-icon> Indispo
                  </p>
                </div>
                <div class="updated-at">
                  Dernière mise à jour le {{ hr.updatedAt | date:"dd" }} {{
                  getMonthString(hr.updatedAt) }} {{ hr.updatedAt | date:"YYYY"
                  }}
                </div>
              </div>
              <div class="read-etp">
                <p class="label">ETP Travaillé :</p>
                <etp-preview [width]="56" [height]="56" [etp]="(hr.etp || 0) - hr.hasIndisponibility"
                  [indisponibility]="hr.hasIndisponibility" class="dark-mode">
                </etp-preview>
              </div>
            </div>
            <div class="activities">
              <div class="flex-1"></div>
              <panel-activities [activities]="hr.currentActivities" [header]="false" [selected]="true" class="dark-mode"
                (referentielChange)="updateHRReferentiel(hr, $event, index)" [updateRefentielOnLoad]="false">
              </panel-activities>
              <div class="flex-1"></div>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</aj-wrapper>

<ng-template #actions>
  <a routerLink="/ventilations" class="reaffectator-page">
    <button class="blue-light small light outline">
      Retour aux ventilations
    </button>
  </a>

  <button class="blue-light light small" (click)="onExport()">
    <mat-icon>save</mat-icon>
    Exporter en PDF
  </button>
</ng-template>