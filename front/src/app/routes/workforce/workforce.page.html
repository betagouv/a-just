<aj-wrapper [title]="'Visualisation <b>instantanée</b> des effectifs'"
  [subtitle]="hrBackup ? 'Dernière mise à jour le ' + hrBackup.date.getDate() + ' ' + getMonthString(hrBackup.date) + ' ' + hrBackup.date.getFullYear() : ''"
  [actionTemplate]="actions" class="content-margin-null">
  <div class="container">
    <div class="title">
      <aj-date-select title="A la date d'" [value]="dateSelected" (valueChange)="onDateChanged($event)">
      </aj-date-select>
      <aj-select title="Pour les contentieux" [value]="selectedReferentielIds" [datas]="formReferentiel"
        (valueChange)="onSelectedReferentielIdsChanged($event)">
      </aj-select>
      <div class="flex-1"></div>
      <div *ngFor="let category of categoriesFilterList; let index = index;" class="checkbox-button"
        [ngClass]="{'blue': index === 0, 'pink': index === 1, 'yellow': index === 2}"
        (click)="checkboxCategory.click()">
        <div>
          <input type="checkbox" #checkboxCategory (click)="$event.stopPropagation()" [(ngModel)]="category.selected"
            (ngModelChange)="onFilterList()" />
        </div>
        <div>
          <p class="label">
            {{ category.nbPersonal }} {{ category.nbPersonal > 1 ?
            category.labelPlural : category.label }}
          </p>
          <p class="etp">{{ category.etpt }} ETP-T</p>
        </div>
      </div>
    </div>

    <div class="content-list">
      <ng-template ngFor let-list let-i="index" [ngForOf]="listFormated" [ngForTrackBy]="trackById">
        <div class="header-list">
          <div class="profil">
            <mat-icon [style.color]="list.textColor">person_outline</mat-icon>
            <div class="label" [style.color]="list.textColor">
              {{ list.label }}
            </div>
            <div class="contentieux-label">
              <div class="text">
                <div class="label">
                  <p>Contentieux :</p>
                </div>
                <div class="etp">
                  <p>ETP affectés :</p>
                </div>
                <div class="flex-1"></div>
              </div>
            </div>
            <!-- <aj-input-button title="Recherche" placeholder="Indiquer le nom" [ngModel]="searchValue"
              (valueChange)="searchValue = $event; updateSearch()" (search)="updateSearch()"></aj-input-button>
            <div class="search-next" *ngIf="valuesFinded !== null">
              <mat-icon matSuffix (click)="onFindNext(-1)" class="cursor-pointer">expand_less
              </mat-icon>
              <mat-icon matSuffix *ngIf="valuesFinded !== null" (click)="onFindNext()" class="cursor-pointer">
                expand_more
              </mat-icon>
            </div> -->
          </div>
          <div class="activities">
            <div class="sub-item" *ngFor="let ref of list.referentiel">
              <div class="color" [ngStyle]="{'background-color': referentielMappingColor(ref.label)}"></div>
              <div class="text">
                <div class="label">
                  <p><b>{{ referentielMappingName(ref.label) }}</b></p>
                </div>
                <div class="etp">
                  <p>{{ ref.totalAffected | number:'0.2-2' }}</p>
                </div>
                <div class="flex-1"></div>
              </div>
            </div>
          </div>
          <div class="actions"></div>
        </div>

        <div class="sub-content-list" [style.background-color]="list.bgColor">
          <div class="item-list" *ngFor="let hr of list.hr; trackBy: trackById" [style.opacity]="hr.opacity"
            [id]="'human-'+hr.id">
            <div class="profil item">
              <div class="text">
                <div class="name">{{ hr.firstName}} {{ hr.lastName}}</div>
                <div class="tags">
                  <p class="function">{{ hr.fonction && hr.fonction.code}}</p>
                  <p class="posad">{{ hr.posadLabel }}</p>
                  <p class="unavailable" *ngIf="hr.hasIndisponibility">
                    <mat-icon>warning_amber</mat-icon> indispo
                  </p>
                  <a [routerLink]="['/resource-humaine', hr.id]">
                    <button mat-icon-button>
                      <mat-icon>edit</mat-icon>
                    </button>
                  </a>
                  <button mat-icon-button (click)="onRemoveRH(hr.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
                  <button mat-icon-button (click)="onDuplicateRH(hr.id)">
                    <mat-icon>file_copy</mat-icon>
                  </button>
                </div>
              </div>
              <div class="read-etp">
                <div>
                  <p class="label">ETP Travaillé :</p>
                  <etp-preview [etp]="(hr.workTime || 0) - hr.hasIndisponibility"
                    [indisponibility]="hr.hasIndisponibility"></etp-preview>
                </div>
              </div>
            </div>
            <div class="activities">
              <div class="sub-activity-panel">
                <div class="sub-item" *ngFor="let ref of referentiel; let index = index">
                  <progression-bar [percent]="getPercentOfActivity(ref, hr)" [selected]="false"
                    (click)="onUpdateActivity(ref, hr)" [color]="referentielMappingColor(ref.label)">
                  </progression-bar>
                </div>
              </div>
              <div class="progress-bar">
                <p>Taux d'affectation : {{ hr.percentAffected | number:'0.0-0' }}%</p>
                <div class="progress-bar-line">
                  <div [style.width.%]="hr.percentAffected"></div>
                </div>
              </div>
            </div>
            <div class="actions"></div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</aj-wrapper>

<aj-popup *ngIf="updateActivity" [title]="updateActivity.referentiel.label" [actions]="[
{ id: 'close', content: 'Fermer' },
{ id: 'modify', content: 'Modifier', fill: true }
]" [closeIcon]="true" (onClose)="updateActivity = null" (selectedAction)="onEditActivities($event)">
  <div class="popup-referentiel">
    <div class="title">
      <div class="label-aj">{{updateActivity.hrActivities[0].label}}</div>
      <progression-bar [percent]="updateActivity.hrActivities[0].percent"
        (percentChange)="updateActivityPercent(updateActivity.hrActivities[0], $event)"
        [color]="referentielMappingColor(updateActivity.referentiel.label)"></progression-bar>
    </div>
    <ng-template [ngIf]="updateActivity.hrActivities.length > 1">
      <div class="or">
        <p>-- ou --</p>
      </div>
      <div class="content">
        <div *ngFor="let ref of updateActivity.hrActivities.slice(1)">
          <div class="label-aj">{{ref.label}}</div>
          <progression-bar [percent]="ref.percent" (percentChange)="updateActivityPercent(ref, $event)"
            [color]="referentielMappingColor(updateActivity.referentiel.label)">
          </progression-bar>
        </div>
      </div>
    </ng-template>
  </div>
</aj-popup>

<ng-template #actions>
  <button class="primary" (click)="addHR()">Ajouter un collaborateur</button>
</ng-template>