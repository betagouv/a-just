<aj-wrapper #wrapper title="Calculateur" [documentation]="documentation" [actionTemplate]="actions"
  class="content-margin-null action-fit-width" [isLoading]="isLoading">
  <div class="container" *ngIf="categorySelected">
    <div class="sub-main-header">
      <aj-date-select title="Pour la période du" [value]="dateStart"
        (valueChange)="updateReferentielSelected('dateStart', $event)" class="date-start bg-white"
        [max]="maxDateSelectionDate" [dateClass]="dateClass">
      </aj-date-select>
      <aj-date-select title="À" [value]="dateStop" (valueChange)="updateReferentielSelected('dateStop', $event)"
        class="date-stop bg-white" [max]="maxDateSelectionDate" [dateClass]="dateClass">
      </aj-date-select>
      <div class="flex-1"></div>
      <button class="ref-button" (click)="calculatorSaver();$event.stopPropagation();">
        <mat-icon>save</mat-icon>
        <div>
          <p>Enregistrer les temps </p>
          <p>moyens constatés</p>
        </div>

      </button>
      <aj-options-backup-panel [readOnly]="true" class="bg-white"></aj-options-backup-panel>
    </div>
    <div class="header-calculator window-scrool-width-margin">
      <div class="title-header-calculator">
        <div class="width-contentieux"></div>
        <div class="item">
          <p>
            Données renseignées
            <i class="ri-lightbulb-flash-line" (click)="onShowPanel('données renseignées')"></i>
            <aj-tooltips title="Données renseignées" class="medium">
              Données renseignées depuis les écrans
              <a routerLink="/ventilations">Affectation des ETP</a> et
              <a routerLink="/donnees-d-activite">Données d’activité</a>
            </aj-tooltips>
          </p>
        </div>
        <div class="item activity">
          <p>
            Activité constatée
            <i class="ri-lightbulb-flash-line" (click)="onShowPanel('activité constatée')"></i>
            <aj-tooltips title="Activité constatée" class="medium">
              Calculs effectués à partir des données constatées
            </aj-tooltips>
          </p>
        </div>
        <div class="item calculate">
          <p>
            Activité calculée
            <i class="ri-lightbulb-flash-line" (click)="onShowPanel('activité calculée')"></i>
            <aj-tooltips title="Activité calculée" class="medium left">
              Calculs théoriques effectués à partir des temps moyens de
              comparaison sélectionnés dans « Mes temps moyens de comparaison »
            </aj-tooltips>
          </p>
        </div>
      </div>
      <div class="contentieux-header-calculator window-scrool-width-margin" title="">
        <div class="width-contentieux">
          <p>Contentieux</p>
        </div>
        <div class="item datas">
          <div (click)="onSortBy('totalIn')" [ngClass]="{'selected': sortBy === 'totalIn'}">
            <div class="flex-1"></div>
            <p>Entrées</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'totalIn'}"></i>
            <aj-tooltips title="Entrées" content="Entrées moyennes mensuelles sur la période choisie"></aj-tooltips>
          </div>
          <div (click)="onSortBy('totalOut')" [ngClass]="{'selected': sortBy === 'totalOut'}">
            <div class="flex-1"></div>
            <p>Sorties</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'totalOut'}"></i>
            <aj-tooltips title="Sorties" content="Sorties moyennes mensuelles sur la période choisie"></aj-tooltips>
          </div>
          <div (click)="onSortBy('lastStock')" [ngClass]="{'selected': sortBy === 'lastStock'}">
            <div class="flex-1"></div>
            <p>Stock</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'lastStock'}"></i>
            <aj-tooltips title="Stock" content="Dossiers en stock à la fin de la période choisie"></aj-tooltips>
          </div>
          <div *ngIf="canViewMagistrat" class="tooltip medium" (click)="onSortBy('etpMag')"
            [ngClass]="{'selected': sortBy === 'etpMag'}">
            <div class="flex-1"></div>
            <p>ETPT <br />Mag.</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'etpMag'}"></i>
            <aj-tooltips class="medium" title="ETPT mag."
              content="Total des ETP travaillés sur la période par les magistrats affectés à ce contentieux">
            </aj-tooltips>
          </div>
          <div *ngIf="canViewGreffier" class="tooltip medium" (click)="onSortBy('etpFon')"
            [ngClass]="{'selected': sortBy === 'etpFon'}">
            <div class="flex-1"></div>
            <p>ETPT<br />Greffe</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'etpFon'}"></i>
            <aj-tooltips class="medium" title="ETPT greffe"
              content="Total des ETP travaillés sur la période par les agents du greffe affectés à ce contentieux">
            </aj-tooltips>
          </div>
          <div *ngIf="canViewContractuel" class="tooltip medium" (click)="onSortBy('etpCont')"
            [ngClass]="{'selected': sortBy === 'etpCont'}">
            <div class="flex-1"></div>
            <p>ETPT<br />Cont.</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'etpCont'}"></i>
            <aj-tooltips class="medium" title="ETPT cont."
              content="Total des ETP travaillés sur la période par les agents contractuels affectés à ce contentieux">
            </aj-tooltips>
          </div>
        </div>
        <div class="item activity">
          <div (click)="onSortBy('realCoverage')" [ngClass]="{'selected': sortBy === 'realCoverage'}">
            <div class="flex-1"></div>
            <p>Taux de<br />couverture</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'realCoverage'}"></i>
            <aj-tooltips title="Taux de couverture" content="SORTIES /ENTREES de la période en %">
            </aj-tooltips>
          </div>
          <div (click)="onSortBy('realDTESInMonths')" [ngClass]="{'selected': sortBy === 'realDTESInMonths'}">
            <div class="flex-1"></div>
            <p>DTES<br />instantané</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'realDTESInMonths'}"></i>
            <aj-tooltips title="DTES instantané" class="medium"
              content="Délai théorique d’écoulement du stock = temps moyen nécessaire au traitement de l’intégralité des affaires en stock compte tenu des sorties enregistrées pour la période antérieure."
              footer="Mode de calcul :<br/><b>STOCK/SORTIES</b>">
            </aj-tooltips>
          </div>
          <div class="tooltip large" (click)="onSortBy('magRealTimePerCase')"
            [ngClass]="{'selected': sortBy === 'magRealTimePerCase'}">
            <div class="flex-1"></div>
            <p>Tps moyen {{ categorySelected }}<br />/ dossier observé</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'magRealTimePerCase'}"></i>
            <aj-tooltips title="Temps moyen par dossier observé" class="large"
              content="Temps moyen consacré au traitement d’un dossier par les ETPT affectés à ce contentieux sur la période."
              footer="Mode de calcul :<br/><b>NOMBRE_HEURES_TRAVAILLEES_PAR_MOIS_PAR_ETPT x ETPT MAG. /SORTIES</b>">
            </aj-tooltips>
          </div>
        </div>
        <div class="item calculate">
          <div class="tooltip" (click)="onSortBy('magCalculateCoverage')"
            [ngClass]="{'selected': sortBy === 'magCalculateCoverage'}">
            <div class="flex-1"></div>
            <p>Taux de<br />couverture</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'magCalculateCoverage'}"></i>
            <aj-tooltips title="Taux de couverture" class="medium"
              content="SORTIES possibles/ENTREES de la période en %">
            </aj-tooltips>
          </div>
          <div class="tooltip large last" (click)="onSortBy('magCalculateDTESInMonths')"
            [ngClass]="{'selected': sortBy === 'magCalculateDTESInMonths'}">
            <div class="flex-1"></div>
            <p>DTES<br />calculé</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'magCalculateDTESInMonths'}"></i>
            <aj-tooltips title="DTES calculé" class="large left"
              content="Délai théorique d’écoulement du stock = temps moyen nécessaire au traitement de l’intégralité des affaires en stock compte tenu des sorties possibles sur la période."
              footer="Mode de calcul :<br/><b>STOCK/SORTIES POSSIBLES</b>">
            </aj-tooltips>
          </div>
          <div class="tooltip large last" (click)="onSortBy('magCalculateTimePerCase')"
            [ngClass]="{'selected': sortBy === 'magCalculateTimePerCase'}">
            <div class="flex-1"></div>
            <p>Temps moyen {{ categorySelected }}<br />/ dossier saisi</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'magCalculateTimePerCase'}"></i>
            <aj-tooltips title="Temps moyen par dossier saisi" class="medium left"
              content="Donnée saisie dans le jeu de données choisi dans «Mes temps moyens de comparaison»">
            </aj-tooltips>
          </div>
          <div class="tooltip large last" (click)="onSortBy('magCalculateOut')"
            [ngClass]="{'selected': sortBy === 'magCalculateOut'}">
            <div class="flex-1"></div>
            <p>Sorties {{ categorySelected }}<br />possibles</p>
            <i class="ri-sort-desc" [ngClass]="{selected: sortBy === 'magCalculateOut'}"></i>
            <aj-tooltips title="Sorties possibles" class="large left"
              content="Nombre moyen de dossiers pouvant être traités mensuellement par les ETPT affectés en fonction du temps moyen de traitement par dossier choisi."
              footer="Mode de calcul :<br/><b>NOMBRE DE DOSSIERS PAR ETPT x ETPT MAGISTRATS</b>">
            </aj-tooltips>
          </div>
        </div>
      </div>
    </div>
    <div class="content-list">
      <aj-referentiel-calculator *ngFor="let r of datasFilted; trackBy: trackByCont" [calculator]="r" [sortBy]="sortBy"
        [categorySelected]="categorySelected">
      </aj-referentiel-calculator>
    </div>
  </div>
</aj-wrapper>

<ng-template #actions>
  <div class="categories-switch">
    <div class="magistrats" *ngIf="canViewMagistrat"
      [ngClass]="{'selected': categorySelected === MAGISTRATS, alone: !canViewGreffier}"
      (click)="$event.stopPropagation(); changeCategorySelected(MAGISTRATS)">
      <input type="radio" [checked]="categorySelected === MAGISTRATS" />
      <p>Siège</p>
    </div>
    <div class="fonctionnaires" *ngIf="canViewGreffier"
      [ngClass]="{'selected': categorySelected === FONCTIONNAIRES, alone: !canViewMagistrat}" class="fonctionnaires"
      (click)="$event.stopPropagation(); changeCategorySelected(FONCTIONNAIRES)">
      <input type="radio" [checked]="categorySelected === FONCTIONNAIRES" />
      <p>Greffe</p>
    </div>
  </div>

  <aj-select title="Fonctions" [value]="selectedFonctionsIds" [datas]="fonctions"
    (valueChange)="onChangeFonctionsSelected($event)">
  </aj-select>

  <div class="flex-1"></div>

  <button class="primary light" (click)="onExport()">
    <mat-icon>save</mat-icon>
    Exporter en PDF
  </button>
</ng-template>