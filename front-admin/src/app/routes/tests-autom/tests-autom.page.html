<aj-wrapper title="Recherche de tests automatisés">
  <div class="tests-autom-container">
    <div class="search-bar">
      <input
        type="text"
        placeholder="Décrivez votre besoin (ex: 'vérifier le chargement du simulateur CA pour le contentieux Pénal')"
        [(ngModel)]="query"
        (keyup.enter)="onSearch()"
      />
      <button (click)="onSearch()" [disabled]="isSearching">{{ isSearching ? 'Recherche…' : 'Rechercher' }}</button>
    </div>

    <div class="state" *ngIf="error">
      <p class="error">{{ error }}</p>
    </div>

    <div class="state" *ngIf="!error && !isSearching && results.length === 0 && query">
      <p>Aucun résultat</p>
    </div>

    <ul class="results" *ngIf="results.length">
      <li *ngFor="let r of results; let i = index">
        <div class="header-row">
          <div class="title">
            {{ r.title }}
            <span class="kind-badge" *ngIf="r.kind || r.source" [ngClass]="r.source === 'api' ? 'badge-backend' : 'badge-e2e'">
              {{ r.kind || (r.source === 'api' ? 'unit test backend' : 'end to end test') }}
            </span>
          </div>
          <div class="score">{{ (r.score * 100) | number:'1.0-0' }}%</div>
        </div>
        <div class="chevron-row">
          <span class="chevron" (click)="onToggleSnippet(i)">{{ snippets[i] ? '▼' : '▶' }}</span>
        </div>
        <div class="snippet" *ngIf="snippets[i]">
          <div class="loading" *ngIf="snippets[i]?.loading">Chargement…</div>
          <div class="snippet-summary" *ngIf="!snippets[i]?.loading && snippets[i]?.summaryFr">
            <p class="summary-text">{{ snippets[i]?.summaryFr }}</p>
          </div>
          <div class="snippet-meta">{{ r.file }}:{{ r.line || snippets[i]?.start }}</div>
          <pre class="code-block" *ngIf="!snippets[i]?.loading" [innerText]="snippets[i]?.content"></pre>
        </div>
      </li>
    </ul>
  </div>
</aj-wrapper>
